<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cardmarket Hub">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <title>Cardmarket Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d0d1a;
            --bg-secondary: #141428;
            --bg-card: #1a1a35;
            --bg-elevated: #222245;
            --accent-primary: #ffd700;
            --accent-secondary: #ff6b35;
            --accent-gradient: linear-gradient(135deg, #ffd700 0%, #ff6b35 100%);
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0;
            --text-muted: #606080;
            --border-color: #2a2a50;
            --success: #00d68f;
            --danger: #ff4757;
            --warning: #ffa502;
            --info: #3498db;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.4);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }

        .app { display: flex; flex-direction: column; height: 100%; max-width: 100%; overflow: hidden; }

        /* Header */
        .header { background: var(--bg-secondary); padding: 12px 16px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 32px; height: 32px; background: var(--accent-gradient); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .logo-text { font-family: 'Space Mono', monospace; font-weight: 700; font-size: 14px; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-actions { display: flex; gap: 6px; }
        .btn-icon { width: 36px; height: 36px; border-radius: var(--radius-sm); border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; transition: all 0.2s; }
        .btn-icon:active { transform: scale(0.95); background: var(--bg-elevated); }
        .btn-icon.syncing { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Tabs */
        .tab-nav { display: flex; gap: 4px; background: var(--bg-card); padding: 4px; border-radius: var(--radius-md); }
        .tab-btn { flex: 1; padding: 8px 6px; border: none; background: transparent; color: var(--text-muted); font-size: 11px; font-family: 'Outfit', sans-serif; font-weight: 500; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .tab-btn .tab-icon { font-size: 16px; }
        .tab-btn.active { background: var(--accent-gradient); color: var(--bg-primary); }
        .tab-btn .tab-badge { background: var(--danger); color: white; font-size: 9px; padding: 1px 5px; border-radius: 10px; font-weight: 700; min-width: 16px; }
        .tab-btn.active .tab-badge { background: var(--bg-primary); color: var(--accent-primary); }

        /* Main */
        .main-content { flex: 1; overflow-y: auto; padding: 12px; padding-bottom: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Section */
        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
        .section-title { font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

        /* Cards */
        .card-wrapper { position: relative; margin-bottom: 10px; overflow: hidden; border-radius: var(--radius-md); }
        .card-delete-bg { position: absolute; inset: 0; background: var(--danger); display: flex; align-items: center; justify-content: flex-end; padding-right: 20px; color: white; font-weight: 600; font-size: 14px; }
        .card-delete-bg::after { content: 'üóëÔ∏è Verwijderen'; }
        .card { background: var(--bg-card); border-radius: var(--radius-md); border: 1px solid var(--border-color); overflow: hidden; position: relative; transition: transform 0.2s ease; z-index: 1; }
        .card.swiping { transition: none; }
        .card.deleting { transform: translateX(-100%); transition: transform 0.3s ease; }
        .card-header { padding: 12px 14px; cursor: pointer; }
        .card-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; }
        .card-title { font-size: 14px; font-weight: 600; color: var(--text-primary); line-height: 1.3; }
        .card-date { font-size: 10px; color: var(--text-muted); white-space: nowrap; font-family: 'Space Mono', monospace; }
        .card-username { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; color: var(--accent-primary); margin-top: 4px; }
        .card-description { font-size: 12px; color: var(--text-secondary); background: var(--bg-secondary); padding: 8px 10px; border-radius: var(--radius-sm); border-left: 3px solid var(--accent-secondary); margin-top: 8px; word-break: break-word; max-height: 80px; overflow: hidden; }
        .card-meta { display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .card-tag { font-size: 10px; padding: 3px 8px; border-radius: 12px; font-weight: 600; }
        .card-tag.photo { background: rgba(255, 107, 53, 0.2); color: var(--accent-secondary); }
        .card-tag.question { background: rgba(255, 165, 2, 0.2); color: var(--warning); }
        .card-tag.done { background: rgba(0, 214, 143, 0.2); color: var(--success); }
        .card-tag.linked { background: rgba(52, 152, 219, 0.2); color: var(--info); }
        .card-tag.no-link { background: rgba(96, 96, 128, 0.2); color: var(--text-muted); }
        .card-photo-count { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-muted); }
        .card-photo-count.has-photos { color: var(--success); }

        .card-actions { display: none; padding: 10px 14px; background: var(--bg-secondary); border-top: 1px solid var(--border-color); gap: 6px; flex-wrap: wrap; }
        .card.expanded .card-actions { display: flex; }
        .card.completed { opacity: 0.6; }

        /* Linked inventory preview */
        .linked-inventory { background: var(--bg-elevated); border-radius: var(--radius-sm); padding: 10px; margin: 10px 14px; border: 1px dashed var(--info); }
        .linked-inventory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .linked-inventory-title { font-size: 12px; color: var(--info); font-weight: 600; }
        .linked-photos { display: flex; gap: 6px; flex-wrap: wrap; }
        .linked-photo { width: 60px; height: 60px; border-radius: var(--radius-sm); overflow: hidden; border: 2px solid var(--info); }
        .linked-photo img { width: 100%; height: 100%; object-fit: cover; }
        .no-linked-photos { font-size: 11px; color: var(--text-muted); }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 5px; padding: 8px 12px; border-radius: var(--radius-sm); border: none; font-size: 12px; font-weight: 500; font-family: 'Outfit', sans-serif; cursor: pointer; transition: all 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--accent-gradient); color: var(--bg-primary); }
        .btn-secondary { background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-success { background: var(--success); color: var(--bg-primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-small { padding: 6px 10px; font-size: 11px; }

        /* Photo Grid */
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; padding: 10px 14px; background: var(--bg-secondary); }
        .photo-item { position: relative; aspect-ratio: 1; border-radius: var(--radius-sm); overflow: hidden; background: var(--bg-card); }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-delete { position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; background: var(--danger); border: none; border-radius: 50%; color: white; font-size: 12px; cursor: pointer; }

        /* Inventory */
        .inventory-controls { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .search-input { flex: 1; min-width: 120px; padding: 10px 14px; border-radius: var(--radius-sm); border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); font-size: 13px; font-family: 'Outfit', sans-serif; }
        .search-input:focus { outline: none; border-color: var(--accent-primary); }
        
        .sort-select { padding: 10px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); font-size: 12px; font-family: 'Outfit', sans-serif; }

        .inventory-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
        .stat-card { background: var(--bg-card); border-radius: var(--radius-sm); padding: 10px; text-align: center; border: 1px solid var(--border-color); }
        .stat-value { font-family: 'Space Mono', monospace; font-size: 18px; font-weight: 700; color: var(--accent-primary); }
        .stat-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }

        /* Inventory Cards */
        .inv-card { background: var(--bg-card); border-radius: var(--radius-md); border: 1px solid var(--border-color); margin-bottom: 8px; overflow: hidden; }
        .inv-card-header { padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .inv-card-info { flex: 1; }
        .inv-card-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .inv-card-details { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .inv-card-right { text-align: right; }
        .inv-card-price { font-family: 'Space Mono', monospace; font-size: 14px; color: var(--success); font-weight: 600; }
        .inv-card-photos { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
        .inv-card-photos.has-photos { color: var(--info); }

        .inv-card-body { display: none; padding: 12px; background: var(--bg-secondary); border-top: 1px solid var(--border-color); }
        .inv-card.expanded .inv-card-body { display: block; }

        .inv-photo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
        .inv-photo-item { position: relative; aspect-ratio: 1; border-radius: var(--radius-sm); overflow: hidden; background: var(--bg-card); border: 2px solid var(--border-color); }
        .inv-photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .inv-photo-item .photo-delete { top: 2px; right: 2px; width: 18px; height: 18px; font-size: 10px; }
        .inv-add-photo { aspect-ratio: 1; border-radius: var(--radius-sm); border: 2px dashed var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--text-muted); cursor: pointer; background: var(--bg-card); }
        .inv-add-photo:hover { border-color: var(--accent-primary); color: var(--accent-primary); }

        .inv-card-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        /* Labels */
        .label-card { background: var(--bg-card); border-radius: var(--radius-md); padding: 12px; border: 1px solid var(--border-color); position: relative; transition: transform 0.2s ease; z-index: 1; }
        .label-card.swiping { transition: none; }
        .label-card.deleting { transform: translateX(-100%); transition: transform 0.3s ease; }
        .label-card .buyer { font-weight: 600; color: var(--accent-primary); margin-bottom: 4px; }
        .label-card .address { font-size: 12px; color: var(--text-secondary); white-space: pre-line; }
        .label-card .items { font-size: 11px; color: var(--text-muted); margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border-color); }
        .label-actions { display: flex; gap: 4px; margin-top: 8px; }

        /* Camera */
        .camera-overlay { position: fixed; inset: 0; background: var(--bg-primary); z-index: 1000; display: none; flex-direction: column; }
        .camera-overlay.active { display: flex; }
        .camera-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-secondary); }
        .camera-title { font-size: 13px; font-weight: 600; color: var(--text-secondary); flex: 1; }
        .camera-preview { flex: 1; position: relative; background: black; overflow: hidden; }
        .camera-preview video { width: 100%; height: 100%; object-fit: cover; }
        .camera-crosshair { position: absolute; inset: 20%; border: 2px dashed rgba(255,215,0,0.5); border-radius: var(--radius-md); pointer-events: none; }
        .focus-indicator { position: absolute; width: 80px; height: 80px; border: 3px solid var(--accent-primary); border-radius: 50%; pointer-events: none; opacity: 0; transform: scale(1.5); transition: all 0.2s ease; }
        .focus-indicator.active { opacity: 1; transform: scale(1); }
        .focus-indicator.focused { border-color: var(--success); }
        .camera-zoom-controls { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 10px 16px; background: var(--bg-card); }
        .zoom-btn { width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border-color); background: var(--bg-elevated); color: var(--text-primary); font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .zoom-btn:active { background: var(--accent-primary); color: var(--bg-primary); }
        #zoomSlider { flex: 1; max-width: 120px; height: 6px; -webkit-appearance: none; appearance: none; background: var(--border-color); border-radius: 3px; outline: none; }
        #zoomSlider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--accent-gradient); cursor: pointer; border: 2px solid white; }
        .zoom-level { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--accent-primary); min-width: 40px; text-align: center; }
        .camera-thumbs { display: flex; gap: 8px; padding: 8px 16px; background: var(--bg-card); overflow-x: auto; min-height: 60px; align-items: center; }
        .camera-thumb { width: 50px; height: 50px; border-radius: var(--radius-sm); overflow: hidden; flex-shrink: 0; border: 2px solid var(--accent-primary); }
        .camera-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .camera-save-option { padding: 8px 16px; background: var(--bg-secondary); display: flex; align-items: center; gap: 8px; }
        .camera-save-option label { font-size: 12px; color: var(--text-secondary); }
        .camera-save-option input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent-primary); }
        .camera-controls { padding: 16px; background: var(--bg-secondary); display: flex; justify-content: center; align-items: center; gap: 24px; }
        .btn-capture { width: 64px; height: 64px; border-radius: 50%; background: var(--accent-gradient); border: 4px solid white; cursor: pointer; position: relative; }
        .btn-capture::after { content: ''; position: absolute; inset: 4px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.3); }
        .btn-gallery { width: 44px; height: 44px; border-radius: 50%; background: var(--bg-elevated); border: 2px solid var(--border-color); cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 900; display: none; align-items: flex-end; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); width: 100%; max-width: 500px; max-height: 85vh; border-radius: var(--radius-lg) var(--radius-lg) 0 0; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-size: 16px; font-weight: 600; }
        .modal-body { padding: 16px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; justify-content: flex-end; }

        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 10px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); font-size: 14px; font-family: 'Outfit', sans-serif; }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); }

        /* Link Modal */
        .link-search-results { max-height: 300px; overflow-y: auto; margin-top: 12px; }
        .link-result-item { padding: 10px; background: var(--bg-card); border-radius: var(--radius-sm); margin-bottom: 6px; cursor: pointer; border: 2px solid transparent; }
        .link-result-item:hover { border-color: var(--accent-primary); }
        .link-result-item.selected { border-color: var(--success); background: rgba(0, 214, 143, 0.1); }
        .link-result-name { font-weight: 600; color: var(--text-primary); }
        .link-result-details { font-size: 11px; color: var(--text-secondary); }
        .link-result-photos { font-size: 10px; color: var(--info); margin-top: 4px; }

        /* Toast */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); padding: 12px 20px; border-radius: var(--radius-md); font-size: 13px; font-weight: 500; z-index: 2000; opacity: 0; transition: all 0.3s ease; max-width: 90%; text-align: center; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); color: var(--bg-primary); }
        .toast.error { background: var(--danger); color: white; }
        .toast.info { background: var(--info); color: white; }

        /* Login */
        .login-screen { position: fixed; inset: 0; background: var(--bg-primary); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; z-index: 100; }
        .login-logo { font-size: 60px; margin-bottom: 16px; }
        .login-title { font-family: 'Space Mono', monospace; font-size: 24px; font-weight: 700; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
        .login-subtitle { color: var(--text-secondary); font-size: 14px; margin-bottom: 32px; text-align: center; }
        .login-btn { display: flex; align-items: center; gap: 12px; padding: 14px 28px; background: white; color: #333; border: none; border-radius: var(--radius-md); font-size: 15px; font-weight: 500; cursor: pointer; margin-bottom: 12px; }
        .login-skip { color: var(--text-muted); font-size: 13px; cursor: pointer; margin-top: 16px; }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 48px; margin-bottom: 12px; }

        .hidden { display: none !important; }
        input[type="file"] { display: none; }

        /* Undo bar */
        .undo-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--bg-elevated); border: 1px solid var(--border-color); padding: 12px 20px; border-radius: var(--radius-md); display: flex; align-items: center; gap: 12px; z-index: 800; box-shadow: var(--shadow-md); }
        .undo-bar.hidden { display: none; }
        .undo-text { font-size: 13px; color: var(--text-secondary); }
        .undo-btn { background: var(--warning); color: var(--bg-primary); border: none; padding: 6px 12px; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">üì¶</div>
        <div class="login-title">Cardmarket Hub</div>
        <div class="login-subtitle">Email classificatie, inventaris beheer<br>en label generatie</div>
        <button class="login-btn" id="btnGoogleLogin">
            <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Inloggen met Google
        </button>
        <div class="login-skip" id="btnSkipLogin">Doorgaan zonder Gmail sync ‚Üí</div>
    </div>

    <!-- Main App -->
    <div class="app hidden" id="mainApp">
        <header class="header">
            <div class="header-top">
                <div class="logo">
                    <div class="logo-icon">üì¶</div>
                    <span class="logo-text">CARDMARKET HUB</span>
                </div>
                <div class="header-actions">
                    <button class="btn-icon" id="btnSync" title="Sync Gmail">üîÑ</button>
                    <button class="btn-icon" id="btnSettings" title="Instellingen">‚öôÔ∏è</button>
                </div>
            </div>
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="photos">
                    <span class="tab-icon">üì∏</span>
                    <span>Foto's</span>
                    <span class="tab-badge hidden" id="photoBadge">0</span>
                </button>
                <button class="tab-btn" data-tab="questions">
                    <span class="tab-icon">‚ùì</span>
                    <span>Vragen</span>
                    <span class="tab-badge hidden" id="questionBadge">0</span>
                </button>
                <button class="tab-btn" data-tab="labels">
                    <span class="tab-icon">üè∑Ô∏è</span>
                    <span>Labels</span>
                    <span class="tab-badge hidden" id="labelBadge">0</span>
                </button>
                <button class="tab-btn" data-tab="inventory">
                    <span class="tab-icon">üìä</span>
                    <span>Inventaris</span>
                </button>
            </nav>
        </header>

        <main class="main-content">
            <!-- Photos Tab -->
            <div class="tab-content active" id="tab-photos">
                <div class="section-header">
                    <span class="section-title">Foto Verzoeken</span>
                    <button class="btn btn-small btn-secondary" id="btnAddPhoto">‚ûï Handmatig</button>
                </div>
                <div id="photoList"></div>
            </div>

            <!-- Questions Tab -->
            <div class="tab-content" id="tab-questions">
                <div class="section-header">
                    <span class="section-title">Vragen</span>
                </div>
                <div id="questionList"></div>
            </div>

            <!-- Labels Tab -->
            <div class="tab-content" id="tab-labels">
                <div class="section-header">
                    <span class="section-title">Verzendlabels</span>
                    <button class="btn btn-small btn-primary" id="btnExportLabels">üìÑ Download Word</button>
                </div>
                <div class="inventory-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="labelCount">0</div>
                        <div class="stat-label">Te versturen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="labelItemCount">0</div>
                        <div class="stat-label">Kaarten</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="labelValue">‚Ç¨0</div>
                        <div class="stat-label">Waarde</div>
                    </div>
                </div>
                <div id="labelList"></div>
            </div>

            <!-- Inventory Tab -->
            <div class="tab-content" id="tab-inventory">
                <div class="inventory-controls">
                    <input type="text" class="search-input" id="inventorySearch" placeholder="üîç Zoek kaart...">
                    <select class="sort-select" id="inventorySort">
                        <option value="name-asc">Naam A-Z</option>
                        <option value="name-desc">Naam Z-A</option>
                        <option value="price-desc">Prijs ‚Üì</option>
                        <option value="price-asc">Prijs ‚Üë</option>
                        <option value="set-asc">Set A-Z</option>
                        <option value="photos-desc">Foto's ‚Üì</option>
                    </select>
                </div>
                <div class="inventory-controls">
                    <button class="btn btn-secondary btn-small" id="btnImportInventory">üì• Import</button>
                    <button class="btn btn-secondary btn-small" id="btnExportInventory">üì§ Export</button>
                </div>
                <div class="inventory-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="invCount">0</div>
                        <div class="stat-label">Kaarten</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="invValue">‚Ç¨0</div>
                        <div class="stat-label">Waarde</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="invWithPhotos">0</div>
                        <div class="stat-label">Met foto's</div>
                    </div>
                </div>
                <div id="inventoryList"></div>
            </div>
        </main>
    </div>

    <!-- Camera Overlay -->
    <div class="camera-overlay" id="cameraOverlay">
        <div class="camera-header">
            <span class="camera-title" id="cameraTitle">Foto maken</span>
            <button class="btn-icon" id="btnCloseCamera">‚úï</button>
        </div>
        <div class="camera-preview" id="cameraPreview">
            <video id="cameraVideo" autoplay playsinline></video>
            <div class="camera-crosshair"></div>
            <div class="focus-indicator" id="focusIndicator"></div>
        </div>
        <div class="camera-zoom-controls">
            <button class="zoom-btn" id="btnZoomOut">‚àí</button>
            <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1">
            <button class="zoom-btn" id="btnZoomIn">+</button>
            <span class="zoom-level" id="zoomLevel">1.0x</span>
        </div>
        <div class="camera-thumbs" id="cameraPhotos"></div>
        <div class="camera-save-option" id="cameraSaveOption">
            <input type="checkbox" id="saveToInventory" checked>
            <label for="saveToInventory">üíæ Opslaan bij inventaris kaart (herbruikbaar)</label>
        </div>
        <div class="camera-controls">
            <button class="btn-gallery" id="btnGallery">üñºÔ∏è</button>
            <button class="btn-capture" id="btnCapture"></button>
            <div style="width: 44px;"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">‚öôÔ∏è Instellingen</span>
                <button class="btn-icon" id="btnCloseSettings">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Gmail Status</label>
                    <div id="gmailStatus" style="color: var(--text-muted);">Niet verbonden</div>
                </div>
                <button class="btn btn-secondary" id="btnLogoutGoogle" style="width:100%; margin-bottom: 12px;">üö™ Uitloggen Gmail</button>
                <button class="btn btn-secondary" id="btnExportData" style="width:100%; margin-bottom: 12px;">üíæ Export alle data</button>
                <button class="btn btn-secondary" id="btnImportData" style="width:100%; margin-bottom: 12px;">üìÇ Import data</button>
                <button class="btn btn-danger" id="btnClearData" style="width:100%;">üóëÔ∏è Wis alle data</button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">‚ûï Taak Toevoegen</span>
                <button class="btn-icon" id="btnCloseAddModal">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-input" id="inputType">
                        <option value="photo">üì∏ Foto verzoek</option>
                        <option value="question">‚ùì Vraag</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Titel / Kaartnaam</label>
                    <input type="text" class="form-input" id="inputTitle" placeholder="bijv. Charizard Base Set">
                </div>
                <div class="form-group">
                    <label class="form-label">Koper username</label>
                    <input type="text" class="form-input" id="inputUsername" placeholder="bijv. BobCM">
                </div>
                <div class="form-group">
                    <label class="form-label">Bericht</label>
                    <textarea class="form-textarea" id="inputDescription" placeholder="Optioneel bericht..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btnCancelAdd">Annuleren</button>
                <button class="btn btn-primary" id="btnSaveTask">Opslaan</button>
            </div>
        </div>
    </div>

    <!-- Link to Inventory Modal -->
    <div class="modal" id="linkModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">üîó Koppel aan inventaris</span>
                <button class="btn-icon" id="btnCloseLinkModal">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Zoek kaart in inventaris</label>
                    <input type="text" class="form-input" id="linkSearchInput" placeholder="Zoek op naam, set...">
                </div>
                <div class="link-search-results" id="linkSearchResults"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btnCancelLink">Annuleren</button>
                <button class="btn btn-primary" id="btnConfirmLink">Koppelen</button>
            </div>
        </div>
    </div>

    <!-- Undo Bar -->
    <div class="undo-bar hidden" id="undoBar">
        <span class="undo-text" id="undoText">Kaart verwijderd</span>
        <button class="undo-btn" id="btnUndo">‚Ü©Ô∏è Ongedaan maken</button>
    </div>

    <!-- Hidden inputs -->
    <input type="file" id="importFile" accept=".json">
    <input type="file" id="inventoryFile" accept=".xlsx,.xls,.csv">
    <input type="file" id="galleryInput" accept="image/*" multiple>
    <input type="file" id="invPhotoInput" accept="image/*" multiple>
    <canvas id="photoCanvas" style="display:none;"></canvas>

    <div class="toast" id="toast"></div>

    <script>
        // =====================================================
        // CONFIGURATION
        // =====================================================
        const GOOGLE_CLIENT_ID = '798382176554-foctga75o3ru9pjnfqv6jtjr0t7kig6v.apps.googleusercontent.com';
        const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';
        const DB_NAME = 'CardmarketHubDB';
        const DB_VERSION = 3;
        const STORE_TASKS = 'tasks';
        const STORE_INVENTORY = 'inventory';
        const STORE_LABELS = 'labels';
        const STORE_CONFIG = 'config';

        // =====================================================
        // STATE
        // =====================================================
        let db = null;
        let googleAccessToken = null;
        let tasks = [];
        let inventory = [];
        let labels = [];
        let currentTaskId = null;
        let currentInventoryId = null;
        let sessionPhotos = [];
        let cameraStream = null;
        let cameraMode = 'task'; // 'task' or 'inventory'
        let selectedLinkId = null;
        let lastDeletedItem = null;
        let undoTimeout = null;

        // Set mappings
        const SET_MAPPINGS = {
            'base set': 'BS', 'jungle': 'JU', 'fossil': 'FO', 'team rocket': 'TR',
            'gym heroes': 'G1', 'gym challenge': 'G2', 'neo genesis': 'N1',
            'neo discovery': 'N2', 'neo revelation': 'N3', 'neo destiny': 'N4',
            'legendary collection': 'LC', 'expedition': 'EX', 'aquapolis': 'AQ',
            'skyridge': 'SK', 'ruby & sapphire': 'RS', 'sandstorm': 'SS',
            'dragon': 'DR', 'team magma vs team aqua': 'MA', 'hidden legends': 'HL',
            'firered & leafgreen': 'RG', 'team rocket returns': 'TRR',
            'deoxys': 'DX', 'emerald': 'EM', 'unseen forces': 'UF',
            'delta species': 'DS', 'legend maker': 'LM', 'holon phantoms': 'HP',
            'crystal guardians': 'CG', 'dragon frontiers': 'DF', 'power keepers': 'PK',
            'diamond & pearl': 'DP', 'mysterious treasures': 'MT', 'secret wonders': 'SW',
            'great encounters': 'GE', 'majestic dawn': 'MD', 'legends awakened': 'LA',
            'stormfront': 'SF', 'platinum': 'PL', 'rising rivals': 'RR',
            'supreme victors': 'SV', 'arceus': 'AR', 'heartgold & soulsilver': 'HS',
            'unleashed': 'UL', 'undaunted': 'UD', 'triumphant': 'TM', 'call of legends': 'CL'
        };

        const LANG_MAPPINGS = { 'english': 'EN', 'german': 'DE', 'french': 'FR', 'japanese': 'JP', 'dutch': 'NL' };

        // =====================================================
        // DATABASE
        // =====================================================
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(STORE_TASKS)) database.createObjectStore(STORE_TASKS, { keyPath: 'id' });
                    if (!database.objectStoreNames.contains(STORE_INVENTORY)) database.createObjectStore(STORE_INVENTORY, { keyPath: 'id' });
                    if (!database.objectStoreNames.contains(STORE_LABELS)) database.createObjectStore(STORE_LABELS, { keyPath: 'id' });
                    if (!database.objectStoreNames.contains(STORE_CONFIG)) database.createObjectStore(STORE_CONFIG, { keyPath: 'key' });
                };
            });
        }

        function dbOp(store, mode, op) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([store], mode);
                const s = tx.objectStore(store);
                const req = op(s);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        async function saveTask(task) { return dbOp(STORE_TASKS, 'readwrite', s => s.put(task)); }
        async function deleteTask(id) { return dbOp(STORE_TASKS, 'readwrite', s => s.delete(id)); }
        async function getAllTasks() { tasks = await dbOp(STORE_TASKS, 'readonly', s => s.getAll()); return tasks; }
        
        async function saveInvItem(item) { return dbOp(STORE_INVENTORY, 'readwrite', s => s.put(item)); }
        async function deleteInvItem(id) { return dbOp(STORE_INVENTORY, 'readwrite', s => s.delete(id)); }
        async function getAllInventory() { inventory = await dbOp(STORE_INVENTORY, 'readonly', s => s.getAll()); return inventory; }
        
        async function saveLabel(label) { return dbOp(STORE_LABELS, 'readwrite', s => s.put(label)); }
        async function deleteLabel(id) { return dbOp(STORE_LABELS, 'readwrite', s => s.delete(id)); }
        async function getAllLabels() { labels = await dbOp(STORE_LABELS, 'readonly', s => s.getAll()); return labels; }
        
        async function getConfig(key) { const r = await dbOp(STORE_CONFIG, 'readonly', s => s.get(key)); return r?.value; }
        async function setConfig(key, value) { return dbOp(STORE_CONFIG, 'readwrite', s => s.put({ key, value })); }

        async function importInventoryItems(items) {
            // Add IDs and import
            const itemsWithIds = items.map((item, i) => ({ ...item, id: Date.now() + i, photos: [] }));
            for (const item of itemsWithIds) await saveInvItem(item);
            return itemsWithIds.length;
        }

        // =====================================================
        // TOAST & UNDO
        // =====================================================
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function showUndo(text, item, type) {
            lastDeletedItem = { item, type };
            document.getElementById('undoText').textContent = text;
            document.getElementById('undoBar').classList.remove('hidden');
            
            clearTimeout(undoTimeout);
            undoTimeout = setTimeout(() => {
                document.getElementById('undoBar').classList.add('hidden');
                lastDeletedItem = null;
            }, 8000);
        }

        async function performUndo() {
            if (!lastDeletedItem) return;
            
            if (lastDeletedItem.type === 'inventory') {
                await saveInvItem(lastDeletedItem.item);
                await getAllInventory();
                renderInventory();
                showToast('Kaart hersteld!', 'success');
            }
            
            document.getElementById('undoBar').classList.add('hidden');
            lastDeletedItem = null;
        }

        // =====================================================
        // TABS & BADGES
        // =====================================================
        function setupTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
                });
            });
        }

        function updateBadges() {
            const photoTasks = tasks.filter(t => t.type === 'photo' && !t.completed);
            const questionTasks = tasks.filter(t => t.type === 'question' && !t.completed);
            
            const setBadge = (id, count) => {
                const el = document.getElementById(id);
                el.textContent = count;
                el.classList.toggle('hidden', count === 0);
            };
            
            setBadge('photoBadge', photoTasks.length);
            setBadge('questionBadge', questionTasks.length);
            setBadge('labelBadge', labels.length);
        }

        // =====================================================
        // RENDER: PHOTO TASKS
        // =====================================================
        function renderPhotoTasks() {
            const container = document.getElementById('photoList');

            const expandedIds = new Set();
            container.querySelectorAll('.card.expanded').forEach(c => expandedIds.add(parseInt(c.dataset.id)));

            const photoTasks = tasks.filter(t => t.type === 'photo').sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                return new Date(b.date) - new Date(a.date);
            });

            if (photoTasks.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì∏</div><p>Geen foto verzoeken</p></div>`;
                return;
            }

            container.innerHTML = photoTasks.map(task => {
                const date = new Date(task.date).toLocaleDateString('nl-NL', { day: '2-digit', month: 'short' });
                const linkedInv = task.inventoryId ? inventory.find(i => i.id === task.inventoryId) : null;
                const invPhotos = linkedInv?.photos || [];
                const taskPhotos = task.photos || [];
                const totalPhotos = invPhotos.length + taskPhotos.length;
                
                return `
                    <div class="card-wrapper" data-type="task" data-id="${task.id}">
                        <div class="card-delete-bg"></div>
                        <div class="card ${task.completed ? 'completed' : ''} ${expandedIds.has(task.id) ? 'expanded' : ''}" data-id="${task.id}">
                            <div class="card-header" onclick="toggleCard('photo', ${task.id})">
                                <div class="card-top">
                                    <span class="card-title">${task.title || 'Geen titel'}</span>
                                    <span class="card-date">${date}</span>
                                </div>
                                <div class="card-username">üë§ ${task.username}</div>
                                ${task.description ? `<div class="card-description">${escapeHtml(task.description)}</div>` : ''}
                            <div class="card-meta">
                                <span class="card-tag photo">üì∏ Foto</span>
                                ${linkedInv ? `<span class="card-tag linked">üîó Gekoppeld</span>` : `<span class="card-tag no-link">‚ö†Ô∏è Niet gekoppeld</span>`}
                                ${task.completed ? '<span class="card-tag done">‚úì Klaar</span>' : ''}
                                <span class="card-photo-count ${totalPhotos > 0 ? 'has-photos' : ''}">üì∑ ${totalPhotos}</span>
                            </div>
                        </div>
                        
                        ${linkedInv ? `
                            <div class="linked-inventory">
                                <div class="linked-inventory-header">
                                    <span class="linked-inventory-title">üîó ${linkedInv.cardName} (${linkedInv.setName}) - ${linkedInv.condition}</span>
                                </div>
                                ${invPhotos.length > 0 ? `
                                    <div class="linked-photos">
                                        ${invPhotos.map(p => `<div class="linked-photo"><img src="${p.data}" alt=""></div>`).join('')}
                                    </div>
                                ` : `<div class="no-linked-photos">Nog geen foto's bij deze kaart</div>`}
                            </div>
                        ` : ''}
                        
                        ${taskPhotos.length > 0 ? `
                            <div class="photo-grid">
                                ${taskPhotos.map((p, i) => `
                                    <div class="photo-item">
                                        <img src="${p.data}" alt="Foto ${i+1}">
                                        <button class="photo-delete" onclick="deleteTaskPhoto(${task.id}, ${i})">‚úï</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="card-actions">
                            ${linkedInv && invPhotos.length > 0 ? `<button class="btn btn-info btn-small" onclick="useLinkedPhotos(${task.id})">üì§ Gebruik gekoppelde foto's</button>` : ''}
                            <button class="btn btn-primary btn-small" onclick="openCameraForTask(${task.id})">üì∏ Foto</button>
                            ${!linkedInv ? `<button class="btn btn-secondary btn-small" onclick="openLinkModal(${task.id})">üîó Koppelen</button>` : ''}
                            ${totalPhotos > 0 ? `<button class="btn btn-secondary btn-small" onclick="downloadAllPhotos(${task.id})">üíæ Download</button>` : ''}
                            <button class="btn btn-info btn-small" onclick="openEmail(${task.id})">‚úâÔ∏è Email</button>
                            <button class="btn btn-success btn-small" onclick="toggleComplete(${task.id})">${task.completed ? '‚Ü©Ô∏è' : '‚úì'}</button>
                            <button class="btn btn-danger btn-small" onclick="removeTask(${task.id})">üóëÔ∏è</button>
                        </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            setupSwipeToDelete();
        }

        function renderQuestionTasks() {
            const container = document.getElementById('questionList');
            const questionTasks = tasks.filter(t => t.type === 'question').sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                return new Date(b.date) - new Date(a.date);
            });

            if (questionTasks.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùì</div><p>Geen vragen</p></div>`;
                return;
            }

            container.innerHTML = questionTasks.map(task => {
                const date = new Date(task.date).toLocaleDateString('nl-NL', { day: '2-digit', month: 'short' });
                return `
                    <div class="card-wrapper" data-type="task" data-id="${task.id}">
                        <div class="card-delete-bg"></div>
                        <div class="card ${task.completed ? 'completed' : ''}" data-id="${task.id}">
                            <div class="card-header" onclick="toggleCard('question', ${task.id})">
                                <div class="card-top">
                                    <span class="card-title">${task.title || 'Vraag'}</span>
                                    <span class="card-date">${date}</span>
                                </div>
                                <div class="card-username">üë§ ${task.username}</div>
                                ${task.description ? `<div class="card-description">${escapeHtml(task.description)}</div>` : ''}
                                <div class="card-meta">
                                    <span class="card-tag question">‚ùì Vraag</span>
                                    ${task.completed ? '<span class="card-tag done">‚úì Klaar</span>' : ''}
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-info btn-small" onclick="openEmail(${task.id})">‚úâÔ∏è Email</button>
                                <button class="btn btn-success btn-small" onclick="toggleComplete(${task.id})">${task.completed ? '‚Ü©Ô∏è' : '‚úì'}</button>
                                <button class="btn btn-danger btn-small" onclick="removeTask(${task.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            setupSwipeToDelete();
        }

        // =====================================================
        // RENDER: INVENTORY
        // =====================================================
        function renderInventory() {
            const search = document.getElementById('inventorySearch').value.toLowerCase();
            const sortBy = document.getElementById('inventorySort').value;
            
            let filtered = inventory.filter(item => 
                item.cardName?.toLowerCase().includes(search) ||
                item.setName?.toLowerCase().includes(search)
            );

            // Sort
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'name-asc': return (a.cardName || '').localeCompare(b.cardName || '');
                    case 'name-desc': return (b.cardName || '').localeCompare(a.cardName || '');
                    case 'price-desc': return (b.price || 0) - (a.price || 0);
                    case 'price-asc': return (a.price || 0) - (b.price || 0);
                    case 'set-asc': return (a.setName || '').localeCompare(b.setName || '');
                    case 'photos-desc': return (b.photos?.length || 0) - (a.photos?.length || 0);
                    default: return 0;
                }
            });

            // Stats
            document.getElementById('invCount').textContent = inventory.length;
            document.getElementById('invValue').textContent = `‚Ç¨${inventory.reduce((sum, i) => sum + (i.price || 0), 0).toFixed(0)}`;
            document.getElementById('invWithPhotos').textContent = inventory.filter(i => i.photos?.length > 0).length;

            const container = document.getElementById('inventoryList');
            
            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìä</div><p>Geen kaarten gevonden</p></div>`;
                return;
            }

            container.innerHTML = filtered.slice(0, 100).map(item => {
                const photoCount = item.photos?.length || 0;
                return `
                    <div class="inv-card" data-id="${item.id}">
                        <div class="inv-card-header" onclick="toggleInvCard(${item.id})">
                            <div class="inv-card-info">
                                <div class="inv-card-name">${item.cardName || 'Onbekend'}</div>
                                <div class="inv-card-details">${item.setName || '-'} ${item.setNumber ? '#'+item.setNumber : ''} ¬∑ ${item.condition || '-'} ¬∑ ${item.language || '-'}</div>
                            </div>
                            <div class="inv-card-right">
                                <div class="inv-card-price">‚Ç¨${(item.price || 0).toFixed(2)}</div>
                                <div class="inv-card-photos ${photoCount > 0 ? 'has-photos' : ''}">üì∑ ${photoCount}</div>
                            </div>
                        </div>
                        <div class="inv-card-body">
                            <div class="inv-photo-grid">
                                ${(item.photos || []).map((p, i) => `
                                    <div class="inv-photo-item">
                                        <img src="${p.data}" alt="Foto ${i+1}">
                                        <button class="photo-delete" onclick="deleteInvPhoto(${item.id}, ${i}); event.stopPropagation();">‚úï</button>
                                    </div>
                                `).join('')}
                                <div class="inv-add-photo" onclick="openCameraForInventory(${item.id}); event.stopPropagation();">+</div>
                            </div>
                            <div class="inv-card-actions">
                                <button class="btn btn-danger btn-small" onclick="markAsSold(${item.id}); event.stopPropagation();">üè∑Ô∏è Verkocht</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (filtered.length > 100) {
                container.innerHTML += `<div class="empty-state"><p style="font-size:12px;">... en ${filtered.length - 100} meer</p></div>`;
            }
        }

        // =====================================================
        // RENDER: LABELS
        // =====================================================
        function renderLabels() {
            document.getElementById('labelCount').textContent = labels.length;
            
            let totalItems = 0, totalValue = 0;
            labels.forEach(l => { totalItems += l.items?.length || 0; totalValue += l.totalPrice || 0; });
            
            document.getElementById('labelItemCount').textContent = totalItems;
            document.getElementById('labelValue').textContent = `‚Ç¨${totalValue.toFixed(0)}`;

            const container = document.getElementById('labelList');
            
            if (labels.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üè∑Ô∏è</div><p>Geen labels te printen</p><p style="font-size: 12px; margin-top: 8px;">Labels worden aangemaakt bij PAID emails</p></div>`;
                return;
            }

            container.innerHTML = labels.map(label => `
                <div class="card-wrapper" data-type="label" data-id="${label.id}">
                    <div class="card-delete-bg"></div>
                    <div class="label-card">
                        <div class="buyer">üì¶ ${label.buyer}</div>
                        <div class="address">${label.address}</div>
                        <div class="items">
                            ${(label.items || []).map(i => `${i.quantity}x ${i.name}`).join(', ')}
                            <br>üí∞ ‚Ç¨${label.totalPrice?.toFixed(2) || '0.00'}
                        </div>
                        <div class="label-actions">
                            <button class="btn btn-success btn-small" onclick="markLabelShipped(${label.id})">‚úì Verstuurd</button>
                            <button class="btn btn-danger btn-small" onclick="removeLabel(${label.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            setupSwipeToDelete();
        }

        // =====================================================
        // CARD TOGGLE
        // =====================================================
        function toggleCard(type, id) {
            const cards = document.querySelectorAll(`#${type === 'photo' ? 'photoList' : 'questionList'} .card`);
            cards.forEach(c => {
                if (parseInt(c.dataset.id) === id) c.classList.toggle('expanded');
                else c.classList.remove('expanded');
            });
        }

        function toggleInvCard(id) {
            const cards = document.querySelectorAll('#inventoryList .inv-card');
            cards.forEach(c => {
                if (parseInt(c.dataset.id) === id) c.classList.toggle('expanded');
                else c.classList.remove('expanded');
            });
        }

        // =====================================================
        // TASK ACTIONS
        // =====================================================
        async function toggleComplete(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                await saveTask(task);
                await getAllTasks();
                renderPhotoTasks();
                renderQuestionTasks();
                updateBadges();
            }
        }

        async function removeTask(id, silent = false) {
            if (silent || confirm('Taak verwijderen?')) {
                await deleteTask(id);
                await getAllTasks();
                renderPhotoTasks();
                renderQuestionTasks();
                updateBadges();
                showToast('Taak verwijderd', 'success');
            }
        }

        async function deleteTaskPhoto(taskId, photoIndex) {
            const task = tasks.find(t => t.id === taskId);
            if (task?.photos) {
                task.photos.splice(photoIndex, 1);
                await saveTask(task);
                await getAllTasks();
                renderPhotoTasks();
            }
        }

        function downloadAllPhotos(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const linkedInv = task.inventoryId ? inventory.find(i => i.id === task.inventoryId) : null;
            const allPhotos = [...(linkedInv?.photos || []), ...(task.photos || [])];
            
            if (allPhotos.length === 0) return;

            allPhotos.forEach((photo, i) => {
                const link = document.createElement('a');
                link.href = photo.data;
                link.download = `${task.username}_${(task.title || 'foto').replace(/[^a-zA-Z0-9]/g, '_')}_${i + 1}.jpg`;
                link.click();
            });
            showToast(`${allPhotos.length} foto's gedownload`, 'success');
        }

        function useLinkedPhotos(taskId) {
            downloadAllPhotos(taskId);
        }

        function openEmail(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            const subject = `Re: ${task.title || 'Cardmarket'}`;
            const body = `Hallo ${task.username},%0D%0A%0D%0A`;
            window.open(`mailto:${task.email || ''}?subject=${encodeURIComponent(subject)}&body=${body}`);
        }

        // =====================================================
        // INVENTORY ACTIONS
        // =====================================================
        async function markAsSold(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;
            
            if (confirm(`"${item.cardName}" als verkocht markeren?`)) {
                await deleteInvItem(id);
                await getAllInventory();
                renderInventory();
                showUndo(`${item.cardName} verwijderd`, item, 'inventory');
            }
        }

        async function deleteInvPhoto(invId, photoIndex) {
            const item = inventory.find(i => i.id === invId);
            if (item?.photos) {
                item.photos.splice(photoIndex, 1);
                await saveInvItem(item);
                await getAllInventory();
                renderInventory();
            }
        }

        // =====================================================
        // CAMERA
        // =====================================================
        async function openCameraForTask(taskId) {
            currentTaskId = taskId;
            currentInventoryId = null;
            cameraMode = 'task';
            
            const task = tasks.find(t => t.id === taskId);
            document.getElementById('cameraTitle').textContent = task?.title || 'Foto maken';
            
            // Show save option if linked to inventory
            const hasLink = task?.inventoryId && inventory.find(i => i.id === task.inventoryId);
            document.getElementById('cameraSaveOption').style.display = hasLink ? 'flex' : 'none';
            document.getElementById('saveToInventory').checked = hasLink;
            
            await startCamera();
        }

        async function openCameraForInventory(invId) {
            currentInventoryId = invId;
            currentTaskId = null;
            cameraMode = 'inventory';
            
            const item = inventory.find(i => i.id === invId);
            document.getElementById('cameraTitle').textContent = item?.cardName || 'Foto maken';
            document.getElementById('cameraSaveOption').style.display = 'none';
            
            await startCamera();
        }

        let currentZoom = 1;
        let maxZoom = 1;
        let cameraTrack = null;
        let cameraCapabilities = null;

        async function startCamera() {
            sessionPhotos = [];
            document.getElementById('cameraPhotos').innerHTML = '';
            currentZoom = 1;
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: { ideal: 'environment' }, 
                        width: { ideal: 4096 }, 
                        height: { ideal: 2160 },
                        focusMode: { ideal: 'continuous' }
                    }
                });
                
                cameraTrack = cameraStream.getVideoTracks()[0];
                
                // Check camera capabilities
                if (cameraTrack.getCapabilities) {
                    cameraCapabilities = cameraTrack.getCapabilities();
                    
                    // Set max zoom
                    if (cameraCapabilities.zoom) {
                        maxZoom = cameraCapabilities.zoom.max || 5;
                        document.getElementById('zoomSlider').max = maxZoom;
                        document.getElementById('zoomSlider').value = 1;
                    }
                    
                    // Enable continuous autofocus
                    if (cameraCapabilities.focusMode && cameraCapabilities.focusMode.includes('continuous')) {
                        await cameraTrack.applyConstraints({ focusMode: 'continuous' });
                    }
                }
                
                document.getElementById('cameraVideo').srcObject = cameraStream;
                document.getElementById('cameraOverlay').classList.add('active');
                
                setupZoomControls();
                setupTapToFocus();
                updateZoomDisplay();
                
            } catch (error) {
                showToast('Camera toegang geweigerd', 'error');
            }
        }

        function setupZoomControls() {
            const slider = document.getElementById('zoomSlider');
            const btnZoomIn = document.getElementById('btnZoomIn');
            const btnZoomOut = document.getElementById('btnZoomOut');

            slider.oninput = (e) => setZoom(parseFloat(e.target.value));
            btnZoomIn.onclick = () => setZoom(Math.min(currentZoom + 0.5, maxZoom));
            btnZoomOut.onclick = () => setZoom(Math.max(currentZoom - 0.5, 1));
        }

        async function setZoom(zoomLevel) {
            if (!cameraTrack || !cameraCapabilities?.zoom) return;

            try {
                currentZoom = Math.max(1, Math.min(zoomLevel, maxZoom));
                await cameraTrack.applyConstraints({ advanced: [{ zoom: currentZoom }] });
                updateZoomDisplay();
            } catch (error) {
                console.error('Zoom error:', error);
            }
        }

        function updateZoomDisplay() {
            document.getElementById('zoomSlider').value = currentZoom;
            document.getElementById('zoomLevel').textContent = currentZoom.toFixed(1) + 'x';
        }

        function setupTapToFocus() {
            const preview = document.getElementById('cameraPreview');
            const focusIndicator = document.getElementById('focusIndicator');

            preview.onclick = async (e) => {
                if (!cameraTrack || !cameraCapabilities) return;

                const rect = preview.getBoundingClientRect();
                const x = (e.clientX - rect.left) / rect.width;
                const y = (e.clientY - rect.top) / rect.height;

                // Show focus indicator
                focusIndicator.style.left = (e.clientX - rect.left - 40) + 'px';
                focusIndicator.style.top = (e.clientY - rect.top - 40) + 'px';
                focusIndicator.classList.add('active');
                focusIndicator.classList.remove('focused');

                try {
                    if (cameraCapabilities.focusMode?.includes('single-shot')) {
                        const constraints = { focusMode: 'single-shot' };
                        if (cameraCapabilities.pointsOfInterest) {
                            constraints.pointsOfInterest = [{ x, y }];
                        }
                        await cameraTrack.applyConstraints(constraints);
                    } else if (cameraCapabilities.focusMode?.includes('continuous')) {
                        await cameraTrack.applyConstraints({ focusMode: 'continuous' });
                    }

                    setTimeout(() => focusIndicator.classList.add('focused'), 300);
                } catch (error) {
                    console.log('Focus niet ondersteund:', error);
                }

                setTimeout(() => focusIndicator.classList.remove('active', 'focused'), 1000);
            };
        }

        async function closeCamera() {
            if (sessionPhotos.length > 0) {
                await saveSessionPhotos();
            }
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            cameraTrack = null;
            cameraCapabilities = null;
            currentZoom = 1;
            
            document.getElementById('cameraOverlay').classList.remove('active');
            currentTaskId = null;
            currentInventoryId = null;
            sessionPhotos = [];
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            const photoData = canvas.toDataURL('image/jpeg', 0.85);
            sessionPhotos.push({ data: photoData, timestamp: new Date().toISOString() });

            const thumb = document.createElement('div');
            thumb.className = 'camera-thumb';
            thumb.innerHTML = `<img src="${photoData}" alt="Foto ${sessionPhotos.length}">`;
            document.getElementById('cameraPhotos').appendChild(thumb);

            document.getElementById('cameraOverlay').style.backgroundColor = 'white';
            setTimeout(() => document.getElementById('cameraOverlay').style.backgroundColor = '', 100);

            showToast(`Foto ${sessionPhotos.length} gemaakt!`, 'success');
        }

        function openGallery() {
            if (cameraMode === 'inventory') {
                document.getElementById('invPhotoInput').click();
            } else {
                document.getElementById('galleryInput').click();
            }
        }

        async function handleGallerySelection(event) {
            const files = event.target.files;
            if (!files?.length) return;

            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                const photoData = await readFileAsDataURL(file);
                sessionPhotos.push({ data: photoData, timestamp: new Date().toISOString() });

                const thumb = document.createElement('div');
                thumb.className = 'camera-thumb';
                thumb.innerHTML = `<img src="${photoData}" alt="Foto">`;
                document.getElementById('cameraPhotos').appendChild(thumb);
            }
            showToast(`${files.length} foto('s) toegevoegd!`, 'success');
            event.target.value = '';
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function saveSessionPhotos() {
            if (sessionPhotos.length === 0) return;

            if (cameraMode === 'inventory' && currentInventoryId) {
                // Save to inventory
                const item = inventory.find(i => i.id === currentInventoryId);
                if (item) {
                    if (!item.photos) item.photos = [];
                    item.photos.push(...sessionPhotos);
                    await saveInvItem(item);
                    await getAllInventory();
                    renderInventory();
                    showToast(`${sessionPhotos.length} foto's opgeslagen bij kaart!`, 'success');
                }
            } else if (cameraMode === 'task' && currentTaskId) {
                const task = tasks.find(t => t.id === currentTaskId);
                if (task) {
                    const saveToInv = document.getElementById('saveToInventory').checked;
                    const linkedInv = task.inventoryId ? inventory.find(i => i.id === task.inventoryId) : null;

                    if (saveToInv && linkedInv) {
                        // Save to linked inventory item
                        if (!linkedInv.photos) linkedInv.photos = [];
                        linkedInv.photos.push(...sessionPhotos);
                        await saveInvItem(linkedInv);
                        await getAllInventory();
                        showToast(`${sessionPhotos.length} foto's opgeslagen bij kaart!`, 'success');
                    } else {
                        // Save to task only
                        if (!task.photos) task.photos = [];
                        task.photos.push(...sessionPhotos);
                        await saveTask(task);
                    }
                    await getAllTasks();
                    renderPhotoTasks();
                }
            }
        }

        // =====================================================
        // LINK MODAL
        // =====================================================
        function openLinkModal(taskId) {
            currentTaskId = taskId;
            selectedLinkId = null;
            
            const task = tasks.find(t => t.id === taskId);
            document.getElementById('linkSearchInput').value = task?.title || '';
            
            document.getElementById('linkModal').classList.add('active');
            updateLinkResults();
        }

        function closeLinkModal() {
            document.getElementById('linkModal').classList.remove('active');
            currentTaskId = null;
            selectedLinkId = null;
        }

        function updateLinkResults() {
            const search = document.getElementById('linkSearchInput').value.toLowerCase();
            const container = document.getElementById('linkSearchResults');
            
            const matches = inventory.filter(item => 
                item.cardName?.toLowerCase().includes(search) ||
                item.setName?.toLowerCase().includes(search)
            ).slice(0, 20);

            if (matches.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">Geen kaarten gevonden</p>';
                return;
            }

            container.innerHTML = matches.map(item => {
                const photoCount = item.photos?.length || 0;
                return `
                    <div class="link-result-item ${selectedLinkId === item.id ? 'selected' : ''}" onclick="selectLinkItem(${item.id})">
                        <div class="link-result-name">${item.cardName}</div>
                        <div class="link-result-details">${item.setName} ¬∑ ${item.condition} ¬∑ ‚Ç¨${(item.price || 0).toFixed(2)}</div>
                        ${photoCount > 0 ? `<div class="link-result-photos">üì∑ ${photoCount} foto's beschikbaar</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function selectLinkItem(invId) {
            selectedLinkId = invId;
            updateLinkResults();
        }

        async function confirmLink() {
            if (!selectedLinkId || !currentTaskId) {
                showToast('Selecteer eerst een kaart', 'error');
                return;
            }

            const task = tasks.find(t => t.id === currentTaskId);
            if (task) {
                task.inventoryId = selectedLinkId;
                await saveTask(task);
                await getAllTasks();
                renderPhotoTasks();
                showToast('Gekoppeld!', 'success');
            }

            closeLinkModal();
        }

        // =====================================================
        // GMAIL INTEGRATION
        // =====================================================
        function loadGoogleAPI() {
            return new Promise((resolve) => {
                if (window.google?.accounts) { resolve(); return; }
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.onload = resolve;
                document.head.appendChild(script);
            });
        }

        async function initGoogleAuth() {
            await loadGoogleAPI();
            const savedToken = await getConfig('googleAccessToken');
            if (savedToken) {
                googleAccessToken = savedToken;
                updateGmailStatus(true);
            }
        }

        function googleLogin() {
            if (GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com') {
                showToast('Configureer eerst je Google Client ID!', 'error');
                return;
            }

            const client = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: GMAIL_SCOPES,
                callback: async (response) => {
                    if (response.access_token) {
                        googleAccessToken = response.access_token;
                        await setConfig('googleAccessToken', googleAccessToken);
                        updateGmailStatus(true);
                        showApp();
                        showToast('Succesvol ingelogd!', 'success');
                    }
                }
            });
            client.requestAccessToken();
        }

        function googleLogout() {
            googleAccessToken = null;
            setConfig('googleAccessToken', null);
            updateGmailStatus(false);
            showToast('Uitgelogd van Google', 'success');
        }

        function updateGmailStatus(connected) {
            document.getElementById('gmailStatus').innerHTML = connected ? '<span style="color: var(--success);">‚úì Verbonden</span>' : 'Niet verbonden';
        }

        async function syncGmail() {
            if (!googleAccessToken) {
                showToast('Log eerst in met Google', 'error');
                return;
            }

            const syncBtn = document.getElementById('btnSync');
            syncBtn.classList.add('syncing');

            try {
                const queries = [
                    'from:noreply@cardmarket.com subject:"Shipment" after:2024/01/01',
                    'from:cardmarket.com subject:"Cardmarket message from" after:2024/01/01'
                ];

                let allMessages = [];
                for (const query of queries) {
                    const searchUrl = `https://www.googleapis.com/gmail/v1/users/me/messages?q=${encodeURIComponent(query)}&maxResults=50`;
                    const response = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
                    
                    if (!response.ok) {
                        if (response.status === 401) { googleLogout(); throw new Error('Token verlopen'); }
                        continue;
                    }
                    
                    const data = await response.json();
                    if (data.messages) allMessages.push(...data.messages);
                }

                let newPhotos = 0, newQuestions = 0, newLabels = 0, updatedInv = 0;

                for (const msg of allMessages) {
                    const existsTask = tasks.find(t => t.gmailMessageId === msg.id);
                    const existsLabel = labels.find(l => l.gmailMessageId === msg.id);
                    if (existsTask || existsLabel) continue;

                    const msgUrl = `https://www.googleapis.com/gmail/v1/users/me/messages/${msg.id}?format=full`;
                    const msgResponse = await fetch(msgUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
                    if (!msgResponse.ok) continue;

                    const msgData = await msgResponse.json();
                    const result = await processEmail(msgData);

                    if (result) {
                        if (result.type === 'photo') newPhotos++;
                        else if (result.type === 'question') newQuestions++;
                        else if (result.type === 'label') newLabels++;
                        if (result.inventoryUpdated) updatedInv += result.inventoryUpdated;
                    }
                }

                await getAllTasks();
                await getAllLabels();
                await getAllInventory();
                
                renderPhotoTasks();
                renderQuestionTasks();
                renderLabels();
                renderInventory();
                updateBadges();

                const messages = [];
                if (newPhotos) messages.push(`${newPhotos} foto's`);
                if (newQuestions) messages.push(`${newQuestions} vragen`);
                if (newLabels) messages.push(`${newLabels} labels`);
                if (updatedInv) messages.push(`${updatedInv} inv.`);

                showToast(messages.length ? messages.join(', ') : 'Geen nieuwe items', messages.length ? 'success' : 'info');

            } catch (error) {
                console.error('Sync error:', error);
                showToast(error.message || 'Sync mislukt', 'error');
            } finally {
                syncBtn.classList.remove('syncing');
            }
        }

        function decodeBase64WithEncoding(base64String, charset = 'utf-8') {
            try {
                // Convert base64url to standard base64
                const base64 = base64String.replace(/-/g, '+').replace(/_/g, '/');
                
                // Decode base64 to binary string
                const binaryString = atob(base64);
                
                // Convert binary string to byte array
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Try decoding with specified charset, fallback to others
                const charsets = [charset, 'utf-8', 'iso-8859-1', 'windows-1252', 'iso-8859-2'];
                
                for (const cs of charsets) {
                    try {
                        const decoder = new TextDecoder(cs, { fatal: true });
                        const result = decoder.decode(bytes);
                        // Check if result looks valid (no replacement characters)
                        if (!result.includes('ÔøΩ')) {
                            return result;
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                // Last resort: non-fatal UTF-8
                const decoder = new TextDecoder('utf-8', { fatal: false });
                return decoder.decode(bytes);
            } catch (error) {
                console.error('Decode error:', error);
                return base64String;
            }
        }

        function getCharsetFromPart(part) {
            // Extract charset from Content-Type header
            const contentType = part.mimeType || '';
            const headers = part.headers || [];
            
            for (const header of headers) {
                if (header.name?.toLowerCase() === 'content-type') {
                    const match = header.value?.match(/charset=["']?([^"';\s]+)/i);
                    if (match) return match[1].toLowerCase();
                }
            }
            
            return 'utf-8';
        }

        function decodeMimeHeader(str) {
            // Decode MIME encoded-word syntax: =?charset?encoding?text?=
            // Example: =?UTF-8?B?SGVsbG8=?= or =?ISO-8859-1?Q?H=E9llo?=
            if (!str) return str;
            
            return str.replace(/=\?([^?]+)\?([BQ])\?([^?]*)\?=/gi, (match, charset, encoding, text) => {
                try {
                    if (encoding.toUpperCase() === 'B') {
                        // Base64 encoding
                        return decodeBase64WithEncoding(text, charset.toLowerCase());
                    } else if (encoding.toUpperCase() === 'Q') {
                        // Quoted-printable encoding
                        const decoded = text
                            .replace(/_/g, ' ')
                            .replace(/=([0-9A-F]{2})/gi, (m, hex) => String.fromCharCode(parseInt(hex, 16)));
                        
                        // Convert to proper charset
                        const bytes = new Uint8Array([...decoded].map(c => c.charCodeAt(0)));
                        const decoder = new TextDecoder(charset.toLowerCase(), { fatal: false });
                        return decoder.decode(bytes);
                    }
                } catch (e) {
                    console.error('MIME decode error:', e);
                }
                return match;
            });
        }

        async function processEmail(gmailMessage) {
            try {
                const headers = gmailMessage.payload.headers;
                let subject = headers.find(h => h.name === 'Subject')?.value || '';
                let from = headers.find(h => h.name === 'From')?.value || '';
                
                // Decode MIME encoded headers
                subject = decodeMimeHeader(subject);
                from = decodeMimeHeader(from);

                let body = '';
                const payload = gmailMessage.payload;
                
                if (payload.body?.data) {
                    const charset = getCharsetFromPart(payload);
                    body = decodeBase64WithEncoding(payload.body.data, charset);
                } else if (payload.parts) {
                    const textPart = payload.parts.find(p => p.mimeType === 'text/plain');
                    if (textPart?.body?.data) {
                        const charset = getCharsetFromPart(textPart);
                        body = decodeBase64WithEncoding(textPart.body.data, charset);
                    }
                }

                if (subject.includes('Please ship')) {
                    return await processPaidEmail(gmailMessage.id, subject, body);
                } else if (subject.includes('SOLD')) {
                    return await processSoldEmail(gmailMessage.id, subject, body);
                } else if (subject.includes('Cardmarket message from')) {
                    return await processMessageEmail(gmailMessage.id, subject, body, from);
                }

                return null;
            } catch (error) {
                console.error('Process email error:', error);
                return null;
            }
        }

        async function processPaidEmail(messageId, subject, body) {
            const buyerMatch = subject.match(/for (.+?):/);
            const buyer = buyerMatch ? buyerMatch[1].trim() : 'Onbekend';
            const shipmentMatch = subject.match(/Shipment (\d+)/);
            const shipmentId = shipmentMatch ? shipmentMatch[1] : Date.now().toString();

            const addressMatch = body.match(/Status:\s*Paid\s+([\s\S]+?)\s+Tracking:/i);
            let address = '';
            if (addressMatch) {
                address = addressMatch[1].trim().split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('Seller:') && !l.startsWith('Buyer:')).join('\n');
            }

            const items = parseItems(body);
            const totalMatch = body.match(/Total sale price:\s*([\d,\.]+)\s*EUR/i);
            const totalPrice = totalMatch ? parseFloat(totalMatch[1].replace(',', '.')) : 0;

            await saveLabel({ id: parseInt(shipmentId), buyer, address, items, totalPrice, gmailMessageId: messageId, date: new Date().toISOString() });

            const updatedCount = await updateInventoryFromItems(items);
            return { type: 'label', inventoryUpdated: updatedCount };
        }

        async function processSoldEmail(messageId, subject, body) {
            const items = parseItems(body);
            const updatedCount = await updateInventoryFromItems(items);
            return { type: 'sold', inventoryUpdated: updatedCount };
        }

        async function processMessageEmail(messageId, subject, body, from) {
            const usernameMatch = subject.match(/Cardmarket message from (.+)/i);
            const username = usernameMatch ? usernameMatch[1].trim() : 'Unknown';
            const buyerMessage = extractBuyerMessage(body);

            const messageLower = buyerMessage.toLowerCase();
            const photoKeywords = ['foto', 'photo', 'picture', 'image', 'pics', 'voor en achterkant', 'front and back', 'condition'];
            const isPhotoRequest = photoKeywords.some(kw => messageLower.includes(kw));

            const cardName = detectCardName(buyerMessage);
            const title = cardName || `Bericht van ${username}`;

            // Try to auto-match with inventory
            let inventoryId = null;
            if (cardName && isPhotoRequest) {
                const match = findInventoryMatch(cardName);
                if (match) inventoryId = match.id;
            }

            const task = {
                id: Date.now(),
                type: isPhotoRequest ? 'photo' : 'question',
                title,
                username,
                email: from.match(/([^\s<]+@cardmarket\.com)/)?.[1] || from,
                description: buyerMessage.substring(0, 500),
                date: new Date().toISOString(),
                completed: false,
                photos: [],
                inventoryId,
                gmailMessageId: messageId
            };

            await saveTask(task);
            return { type: task.type };
        }

        function findInventoryMatch(searchText) {
            const lower = searchText.toLowerCase();
            return inventory.find(item => {
                const cardLower = (item.cardName || '').toLowerCase();
                return cardLower.includes(lower) || lower.includes(cardLower);
            });
        }

        function parseItems(body) {
            const items = [];
            const itemRegex = /(\d+)x\s+(.+?)\s+\((.+?)\)\s+-\s+(\w+)\s+-\s+(\w+)\s+-\s+(\w+)\s+([\d,\.]+)\s*EUR/gi;
            let match;
            while ((match = itemRegex.exec(body)) !== null) {
                items.push({
                    quantity: parseInt(match[1]),
                    name: match[2].trim(),
                    set: match[3].trim(),
                    condition: match[6].trim(),
                    price: parseFloat(match[7].replace(',', '.'))
                });
            }
            return items;
        }

        async function updateInventoryFromItems(items) {
            if (!items.length || !inventory.length) return 0;

            let updatedCount = 0;
            for (const item of items) {
                const normalizedSet = normalizeSetName(item.set);

                for (let q = 0; q < item.quantity; q++) {
                    const matchIndex = inventory.findIndex(inv => {
                        const nameMatch = inv.cardName?.toLowerCase() === item.name.toLowerCase();
                        const setMatch = inv.setName?.toUpperCase() === normalizedSet?.toUpperCase();
                        const condMatch = inv.condition?.toUpperCase() === item.condition?.toUpperCase();
                        const priceTolerance = inv.price ? Math.abs(inv.price - item.price) / inv.price < 0.3 : true;
                        return nameMatch && setMatch && condMatch && priceTolerance;
                    });

                    if (matchIndex !== -1) {
                        await deleteInvItem(inventory[matchIndex].id);
                        inventory.splice(matchIndex, 1);
                        updatedCount++;
                    }
                }
            }
            return updatedCount;
        }

        function normalizeSetName(setName) {
            return SET_MAPPINGS[setName.toLowerCase()] || setName;
        }

        function extractBuyerMessage(body) {
            let message = body;
            const headerEnd = message.indexOf('to Strepto1:');
            if (headerEnd > -1) message = message.substring(headerEnd + 12);
            message = message.replace(/^[-]+$/gm, '').replace(/Please reply above this line.*/is, '').replace(/To view the message on Cardmarket.*/is, '');
            return message.trim();
        }

        function detectCardName(text) {
            const patterns = [
                /foto(?:'s)?\s+(?:van\s+)?(?:de\s+)?(.+?)(?:\?|$)/i,
                /photo(?:s)?\s+(?:of\s+)?(?:the\s+)?(.+?)(?:\?|$)/i,
                /(.+?)\s+\([A-Z]{2,3}\s*\d+\)/i
            ];
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match?.[1]) {
                    let cardName = match[1].trim().replace(/please|thank|thanks|you|hoi|hi|hello|kevin/gi, '').trim();
                    if (cardName.length > 2 && cardName.length < 80) return cardName;
                }
            }
            return null;
        }

        // =====================================================
        // LABEL EXPORT
        // =====================================================
        function exportLabelsToWord() {
            if (!labels.length) { showToast('Geen labels', 'error'); return; }

            let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word">
            <head><meta charset="UTF-8"><style>
                @page { size: A4; margin: 1cm; }
                body { font-family: Arial; font-size: 16pt; }
                .container { display: flex; flex-wrap: wrap; }
                .label { width: 45%; padding: 15px; margin: 10px 2%; border: 1px solid #ccc; page-break-inside: avoid; min-height: 100px; }
                .address { white-space: pre-line; line-height: 1.4; }
            </style></head><body><div class="container">`;

            labels.forEach(l => { html += `<div class="label"><div class="address">${l.address.replace(/\n/g, '<br>')}</div></div>`; });
            html += '</div></body></html>';

            const blob = new Blob([html], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `labels_${new Date().toISOString().split('T')[0]}.doc`;
            link.click();
            showToast(`${labels.length} labels ge√´xporteerd!`, 'success');
        }

        async function markLabelShipped(id) {
            await deleteLabel(id);
            await getAllLabels();
            renderLabels();
            updateBadges();
            showToast('Verstuurd!', 'success');
        }

        async function removeLabel(id, silent = false) {
            if (silent || confirm('Label verwijderen?')) {
                await deleteLabel(id);
                await getAllLabels();
                renderLabels();
                updateBadges();
                showToast('Label verwijderd', 'success');
            }
        }

        // =====================================================
        // INVENTORY IMPORT/EXPORT
        // =====================================================
        async function handleInventoryImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);

                const items = json.map(row => ({
                    cardName: row['Card Name'] || row['cardName'] || '',
                    setName: row['SET NAME'] || row['setName'] || row['Set'] || '',
                    setNumber: row['SET #'] || row['setNumber'] || '',
                    condition: row['Condition'] || row['condition'] || '',
                    language: row['Language'] || row['language'] || '',
                    price: parseFloat(row['Price (‚Ç¨)'] || row['price'] || row['Price'] || 0),
                    reverse: row['Reverse'] || '',
                    firstEdition: row['First Edition (1st)'] || row['firstEdition'] || ''
                }));

                const count = await importInventoryItems(items);
                await getAllInventory();
                renderInventory();
                showToast(`${count} kaarten ge√Ømporteerd!`, 'success');
            } catch (error) {
                showToast('Import mislukt: ' + error.message, 'error');
            }
            event.target.value = '';
        }

        function exportInventoryToExcel() {
            if (!inventory.length) { showToast('Geen inventaris', 'error'); return; }

            const data = inventory.map(item => ({
                'Card Name': item.cardName,
                'SET NAME': item.setName,
                'SET #': item.setNumber,
                'Condition': item.condition,
                'Language': item.language,
                'Price (‚Ç¨)': item.price,
                'Reverse': item.reverse,
                'First Edition (1st)': item.firstEdition
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'CardMarket');
            XLSX.writeFile(wb, `inventaris_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Inventaris ge√´xporteerd!', 'success');
        }

        // =====================================================
        // MODALS & UI
        // =====================================================
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function openAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('active');
            document.getElementById('inputTitle').value = '';
            document.getElementById('inputUsername').value = '';
            document.getElementById('inputDescription').value = '';
        }

        function closeAddTaskModal() { document.getElementById('addTaskModal').classList.remove('active'); }
        function openSettingsModal() { document.getElementById('settingsModal').classList.add('active'); }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.remove('active'); }

        async function saveManualTask() {
            const type = document.getElementById('inputType').value;
            const title = document.getElementById('inputTitle').value.trim();
            const username = document.getElementById('inputUsername').value.trim();
            const description = document.getElementById('inputDescription').value.trim();

            if (!title || !username) { showToast('Vul titel en username in', 'error'); return; }

            // Try to auto-match
            let inventoryId = null;
            if (type === 'photo') {
                const match = findInventoryMatch(title);
                if (match) inventoryId = match.id;
            }

            const task = {
                id: Date.now(), type, title, username, email: '',
                description: description || 'Handmatig toegevoegd',
                date: new Date().toISOString(), completed: false, photos: [], inventoryId, gmailMessageId: null
            };

            await saveTask(task);
            await getAllTasks();
            renderPhotoTasks();
            renderQuestionTasks();
            updateBadges();
            closeAddTaskModal();
            showToast('Taak toegevoegd!' + (inventoryId ? ' (gekoppeld)' : ''), 'success');
        }

        async function exportAllData() {
            const data = { tasks, labels, inventory, exportDate: new Date().toISOString(), version: 3 };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `cardmarket-hub-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showToast('Data ge√´xporteerd!', 'success');
        }

        async function handleDataImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (data.tasks) for (const t of data.tasks) await saveTask(t);
                if (data.labels) for (const l of data.labels) await saveLabel(l);
                if (data.inventory) for (const i of data.inventory) await saveInvItem(i);

                await Promise.all([getAllTasks(), getAllLabels(), getAllInventory()]);
                renderPhotoTasks(); renderQuestionTasks(); renderLabels(); renderInventory(); updateBadges();
                showToast('Data ge√Ømporteerd!', 'success');
            } catch (error) {
                showToast('Import mislukt', 'error');
            }
            event.target.value = '';
        }

        async function clearAllData() {
            if (confirm('ALLE data wissen?')) {
                for (const store of [STORE_TASKS, STORE_LABELS, STORE_INVENTORY]) {
                    const tx = db.transaction([store], 'readwrite');
                    tx.objectStore(store).clear();
                }
                tasks = []; labels = []; inventory = [];
                renderPhotoTasks(); renderQuestionTasks(); renderLabels(); renderInventory(); updateBadges();
                closeSettingsModal();
                showToast('Data gewist', 'success');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =====================================================
        // SWIPE TO DELETE
        // =====================================================
        function setupSwipeToDelete() {
            document.querySelectorAll('.card-wrapper').forEach(wrapper => {
                if (wrapper.dataset.swipeSetup) return;
                wrapper.dataset.swipeSetup = 'true';
                
                const card = wrapper.querySelector('.card') || wrapper.querySelector('.label-card');
                if (!card) return;
                
                let startX = 0;
                let currentX = 0;
                let isDragging = false;
                
                const onTouchStart = (e) => {
                    startX = e.touches[0].clientX;
                    isDragging = true;
                    card.classList.add('swiping');
                };
                
                const onTouchMove = (e) => {
                    if (!isDragging) return;
                    currentX = e.touches[0].clientX - startX;
                    
                    // Only allow swipe left
                    if (currentX < 0) {
                        card.style.transform = `translateX(${currentX}px)`;
                    }
                };
                
                const onTouchEnd = async () => {
                    if (!isDragging) return;
                    isDragging = false;
                    card.classList.remove('swiping');
                    
                    const threshold = -100;
                    
                    if (currentX < threshold) {
                        // Delete
                        card.classList.add('deleting');
                        
                        const type = wrapper.dataset.type;
                        const id = parseInt(wrapper.dataset.id);
                        
                        setTimeout(async () => {
                            if (type === 'task') {
                                await removeTask(id, true);
                            } else if (type === 'label') {
                                await removeLabel(id, true);
                            }
                        }, 300);
                    } else {
                        // Snap back
                        card.style.transform = '';
                    }
                    
                    currentX = 0;
                };
                
                card.addEventListener('touchstart', onTouchStart, { passive: true });
                card.addEventListener('touchmove', onTouchMove, { passive: true });
                card.addEventListener('touchend', onTouchEnd);
            });
        }

        // =====================================================
        // EVENT LISTENERS
        // =====================================================
        function setupEventListeners() {
            document.getElementById('btnGoogleLogin').addEventListener('click', googleLogin);
            document.getElementById('btnSkipLogin').addEventListener('click', () => { showApp(); showToast('Offline modus', 'info'); });
            document.getElementById('btnSync').addEventListener('click', syncGmail);
            document.getElementById('btnSettings').addEventListener('click', openSettingsModal);
            document.getElementById('btnAddPhoto').addEventListener('click', openAddTaskModal);
            document.getElementById('btnExportLabels').addEventListener('click', exportLabelsToWord);
            document.getElementById('btnImportInventory').addEventListener('click', () => document.getElementById('inventoryFile').click());
            document.getElementById('btnExportInventory').addEventListener('click', exportInventoryToExcel);
            document.getElementById('inventoryFile').addEventListener('change', handleInventoryImport);
            document.getElementById('inventorySearch').addEventListener('input', renderInventory);
            document.getElementById('inventorySort').addEventListener('change', renderInventory);
            document.getElementById('btnCloseCamera').addEventListener('click', closeCamera);
            document.getElementById('btnCapture').addEventListener('click', capturePhoto);
            document.getElementById('btnGallery').addEventListener('click', openGallery);
            document.getElementById('galleryInput').addEventListener('change', handleGallerySelection);
            document.getElementById('invPhotoInput').addEventListener('change', handleGallerySelection);
            document.getElementById('btnCloseAddModal').addEventListener('click', closeAddTaskModal);
            document.getElementById('btnCancelAdd').addEventListener('click', closeAddTaskModal);
            document.getElementById('btnSaveTask').addEventListener('click', saveManualTask);
            document.getElementById('btnCloseSettings').addEventListener('click', closeSettingsModal);
            document.getElementById('btnLogoutGoogle').addEventListener('click', () => { googleLogout(); closeSettingsModal(); });
            document.getElementById('btnExportData').addEventListener('click', exportAllData);
            document.getElementById('btnImportData').addEventListener('click', () => document.getElementById('importFile').click());
            document.getElementById('importFile').addEventListener('change', handleDataImport);
            document.getElementById('btnClearData').addEventListener('click', clearAllData);
            document.getElementById('btnCloseLinkModal').addEventListener('click', closeLinkModal);
            document.getElementById('btnCancelLink').addEventListener('click', closeLinkModal);
            document.getElementById('btnConfirmLink').addEventListener('click', confirmLink);
            document.getElementById('linkSearchInput').addEventListener('input', updateLinkResults);
            document.getElementById('btnUndo').addEventListener('click', performUndo);

            document.getElementById('addTaskModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeAddTaskModal(); });
            document.getElementById('settingsModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeSettingsModal(); });
            document.getElementById('linkModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeLinkModal(); });
        }

        // =====================================================
        // INIT
        // =====================================================
        async function init() {
            try {
                await initDB();
                await Promise.all([getAllTasks(), getAllLabels(), getAllInventory()]);
                await initGoogleAuth();

                setupTabs();
                setupEventListeners();
                
                renderPhotoTasks();
                renderQuestionTasks();
                renderLabels();
                renderInventory();
                updateBadges();

                if (googleAccessToken) showApp();
                else showLogin();

                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js').catch(err => console.log('SW failed:', err));
                }
            } catch (error) {
                console.error('Init error:', error);
                showToast('Init fout: ' + error.message, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
